name: 'Setup K0s Kubernetes'
description: 'Install K0s Kubernetes distribution'
inputs:
  extra-params:
    description: 'Extra parameters to pass to k0s install'
    required: false
    default: ''
runs:
  using: 'composite'
  steps:
    - name: Free up disk space
      shell: bash
      run: |
        echo "üßπ Removing unnecessary directories to free up disk space..."
        sudo rm -rf /usr/local/.ghcup
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo rm -rf /usr/lib/jvm
        sudo rm -rf /usr/share/swift
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /usr/local/julia*
        sudo rm -rf /opt/az
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /opt/microsoft
        sudo rm -rf /opt/google
        sudo rm -rf /usr/lib/firefox
        echo "‚úÖ Disk space freed up"
        df -h / | grep -v Filesystem

    - name: Install K0s
      shell: bash
      run: |
        echo "üì¶ Installing K0s..."
        curl -sSLf https://get.k0s.sh | sudo sh
        
        # Install k0s controller
        sudo k0s install controller --single ${{ inputs.extra-params }}
        
        # kube-router uses :8080 for metrics, which causes issues in k0s 1.30.0+
        # Change metricsPort to :9999 to avoid conflicts
        sudo mkdir -p /etc/k0s
        k0s config create | sudo tee /etc/k0s/k0s.yaml
        sudo sed -i -e "s/metricsPort: 8080/metricsPort: 9999/g" /etc/k0s/k0s.yaml
        
        sudo k0s start
        
        echo "‚è≥ Waiting for K0s to be ready..."
        sleep 120
    
    - name: Setup kubectl
      shell: bash
      run: |
        echo "üîß Setting up kubectl..."
        
        # Download the kubectl binary into /usr/bin
        ARCH=$(uname -m)
        case "${ARCH}" in
          x86_64) ARCH="amd64" ;;
          aarch64) ARCH="arm64" ;;
        esac
        
        kubectl_version=$(sudo k0s kubectl version 2>/dev/null | grep "Client Version" | sed -e 's/Client Version: //')
        sudo curl -fL --progress-bar -o /usr/bin/kubectl https://dl.k8s.io/release/"${kubectl_version}"/bin/linux/"${ARCH}"/kubectl
        sudo chmod +x /usr/bin/kubectl
        
        mkdir -p ~/.kube
        sudo cp /var/lib/k0s/pki/admin.conf ~/.kube/config
        sudo chown "${USER}":"${USER}" ~/.kube/config
        
        echo "‚úÖ kubectl installed: $(kubectl version --client)"
    
    - name: Verify cluster
      shell: bash
      run: |
        echo "üîç Verifying K0s cluster..."
        kubectl get nodes
        kubectl get pods -A
        
        # Wait for system pods to be ready (excluding completed/job pods)
        echo "‚è≥ Waiting for system pods..."
        # Wait only for Running pods (not Completed/Job pods)
        kubectl wait --for=condition=Ready pods --all -n kube-system --timeout=10m \
          --field-selector=status.phase!=Succeeded,status.phase!=Failed || true
        
        # Verify all pods are either Running or Completed
        NOT_READY=$(kubectl get pods -n kube-system -o json | \
          jq -r '.items[] | select(.status.phase != "Running" and .status.phase != "Succeeded") | .metadata.name')
        
        if [ -n "$NOT_READY" ]; then
          echo "‚ùå Some pods are not ready:"
          echo "$NOT_READY"
          kubectl get pods -A
          exit 1
        fi
        
        echo "‚úÖ K0s cluster is ready!"
